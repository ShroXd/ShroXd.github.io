<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Styled Component"><meta name="keywords" content="CSS in JS,Styled-Component"><meta name="author" content="ShroXd"><meta name="copyright" content="ShroXd"><title>Styled Component | Space Cowboy</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.8.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.8.2"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.8.2"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '4.2.0'
} </script><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Space Cowboy" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#难以隔离的-css"><span class="toc-number">1.</span> <span class="toc-text"> 难以隔离的 CSS</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#styled-component-源码"><span class="toc-number">2.</span> <span class="toc-text"> Styled-Component 源码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#两个核心问题"><span class="toc-number">2.1.</span> <span class="toc-text"> 两个核心问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tag-function"><span class="toc-number">2.2.</span> <span class="toc-text"> Tag function</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#styled-绑定的一组解析函数"><span class="toc-number">2.3.</span> <span class="toc-text"> styled 绑定的一组解析函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#constructwithoptions"><span class="toc-number">2.4.</span> <span class="toc-text"> constructWithOptions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#css"><span class="toc-number">2.5.</span> <span class="toc-text"> css</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#createstyledcomponent"><span class="toc-number">2.6.</span> <span class="toc-text"> createStyledComponent</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://bebopfzj.oss-cn-hangzhou.aliyuncs.com/uPic/2020-03-09-bxgaD3.png"></div><div class="author-info__name text-center">ShroXd</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">58</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">118</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">8</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://bebopfzj.oss-cn-hangzhou.aliyuncs.com/uPic/2020-10-18-WIuOpc.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Space Cowboy</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">Styled Component</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-05-16</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E6%A1%86%E6%9E%B6/">框架</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">2k</span><span class="post-meta__separator">|</span><span>Reading time: 8 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="难以隔离的-css"><a class="markdownIt-Anchor" href="#难以隔离的-css"></a> 难以隔离的 CSS</h1>
<p>你可能已经知道了，CSS 样式的应用是基于选择器的。例如如下代码：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>会为 <code>div</code> 元素应用一段 CSS 代码。但显而易见的是，这种设计会导致不可避免的问题——<strong>冲突</strong>。<br />
事实上，原生 CSS 无法提供模块隔离的特性。我们必须借助额外的设计来处理这个问题。特别是在传统的 React 中，我们经常需要将逻辑、样式等代码写在一起，这就会导致很麻烦的样式冲突问题。<br />
也许你听说过 <code>BEM</code>，这种方法提出了一些原则，程序员只要遵守这个原则，就可以写出低冲突风险的代码：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.Block__Emelemt--Modifier</span> &#123;</span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但这也意味着用户需要手动去处理各种命名，这是很麻烦的事情。也许我们可以采用更加自动化的方式来处理这个事情。<br />
Styled-Component 是 React 生态下一个比较好的处理方案。尽管它本质上也是通过处理 <code>class</code> 来完成样式的应用和隔离，但因为导出的是 React 组件，且拥有继承的特性，效果还是很好的。</p>
<h1 id="styled-component-源码"><a class="markdownIt-Anchor" href="#styled-component-源码"></a> Styled-Component 源码</h1>
<p>因为这是个比较大的项目，所以这边的源码分析只专注于最核心的东西。为了说明一些问题，可能会对源码进行修改，只留下最本质的东西。但这并不意味着那些被删除的代码不重要。</p>
<h2 id="两个核心问题"><a class="markdownIt-Anchor" href="#两个核心问题"></a> 两个核心问题</h2>
<ol>
<li>如何处理语法</li>
<li>如何处理 css 匹配</li>
<li>ComponentStyle</li>
<li>useStyledComponentImpl</li>
</ol>
<h2 id="tag-function"><a class="markdownIt-Anchor" href="#tag-function"></a> Tag function</h2>
<p>一个很常见的 <code>styled-components</code> 组件的写法是：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Button = styled.button<span class="string">`</span></span><br><span class="line"><span class="string">	color: grey;</span></span><br><span class="line"><span class="string">`</span>;</span><br></pre></td></tr></table></figure>
<p>而这个看似 <em>怪异</em> 的写法实际上是 ES6 的 tag function 特性。</p>
<p>简单来说，你可以调用一个函数来解析模板字符串。这个模板字符串将会被作为第一个参数而传入函数。值得注意的是，这个解析函数并不一定需要再次返回字符串。</p>
<p>下面是一个例子：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayHello</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`Hello, my name is <span class="subst">$&#123;name&#125;</span>`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sayHello<span class="string">`Spike`</span>		<span class="comment">// Hello, my name is Spike</span></span><br></pre></td></tr></table></figure>
<p>不过这只是最基础的用法。真正让这个特性发挥威力的是它对含参模板字符串的解析逻辑。同时，这也是理解 <code>styled-components</code> 原理的基础。</p>
<p>下面是一个例子：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parser</span>(<span class="params">strings, ...args</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"strings: "</span>, strings);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"args"</span>, args);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="string">`Hello, <span class="subst">$&#123;strings[<span class="number">0</span>]&#125;</span>`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(parser<span class="string">`Jet <span class="subst">$&#123;nice&#125;</span>`</span>);</span><br><span class="line"><span class="comment">// strings: ["Jet", ""]</span></span><br><span class="line"><span class="comment">// args: ["nice"]</span></span><br><span class="line"><span class="comment">// Hello, Jet</span></span><br></pre></td></tr></table></figure>
<p>有几个需要注意的地方：</p>
<ul>
<li>传入解析函数的模板字符串会以变量处为分界线，拆分为多个字符串，以数组的方式传入</li>
<li>传入解析函数的模板字符串的变量将会被分别传入</li>
</ul>
<p>所以如果你能确定传入的变量数量时，你也可以这样写这个解析函数：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parser</span>(<span class="params">strings, arg1, arg2</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经由上面的内容，我们就可以分析一下一个常规的 <code>styled-components</code> 将会如何接收函数。</p>
<p>假设我们有如下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">styled.div<span class="string">`</span></span><br><span class="line"><span class="string">	background-color: red;</span></span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure>
<p>解析函数将会接收到这样的参数：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">`</span></span><br><span class="line"><span class="string">	background-color: red;</span></span><br><span class="line"><span class="string">`</span>]</span><br></pre></td></tr></table></figure>
<p>当我们在使用 <code>styled-compoent</code> 时使用了变量，比如：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> color = <span class="string">"red"</span>;</span><br><span class="line">styled.button<span class="string">`</span></span><br><span class="line"><span class="string"> background-color: <span class="subst">$&#123;color&#125;</span>;</span></span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure>
<p>那接收到的参数将会像是这样：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">`background-color" `</span>, <span class="string">`;`</span>]</span><br><span class="line">[<span class="string">'red'</span>]</span><br></pre></td></tr></table></figure>
<p>另外的，通过这些写法，可以很容易猜到 <code>styled-components</code> 是如何组织这些解析函数的：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> styled = &#123;</span><br><span class="line">	div: <span class="function">(<span class="params">strings, ...vals</span>) =&gt;</span> &#123;&#125;,</span><br><span class="line">	button: <span class="function">(<span class="params">strings, ...vals</span>) =&gt;</span> &#123;&#125;,</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单来说，这些解析函数将会接收你传入的信息，解析它们，并返回一个 React Component。</p>
<h2 id="styled-绑定的一组解析函数"><a class="markdownIt-Anchor" href="#styled-绑定的一组解析函数"></a> styled 绑定的一组解析函数</h2>
<p>在 styled-component 中，我们可以写出这样的代码：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Button = styled.button<span class="string">`</span></span><br><span class="line"><span class="string">    // ...</span></span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure>
<p>也许你已经能猜到了，我们可以这样写的原因无非是我们将各种原生 Element 都绑定在了 <code>styled</code> 上，类似这样：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> styled = &#123;</span><br><span class="line">    div,</span><br><span class="line">    button,</span><br><span class="line">    h1,</span><br><span class="line">    h2,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不过手动绑定有点繁琐，那么看看源码中是怎么处理的。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> domElements = [</span><br><span class="line">    <span class="string">'a'</span>,</span><br><span class="line">    <span class="string">'div'</span>,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styled = &lt;Props&gt;<span class="function">(<span class="params">tag: WebTarget</span>) =&gt;</span></span><br><span class="line">    constructWithOptions&lt;IStyledComponentFactory, Props&gt;(</span><br><span class="line">        createStyledComponent, tag</span><br><span class="line">    )</span><br><span class="line"><span class="keyword">type</span> BaseStyled = <span class="keyword">typeof</span> styled;</span><br><span class="line"><span class="keyword">const</span> enhancedStyled = styled <span class="keyword">as</span> BaseStyled &amp; </span><br><span class="line">    &#123;</span><br><span class="line">        [key <span class="keyword">in</span> <span class="keyword">typeof</span> domElements[<span class="built_in">number</span>]]: ReturnType&lt;BaseStyled&gt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">domElements.forEach(<span class="function"><span class="params">domElement</span> =&gt;</span> &#123;</span><br><span class="line">    enhancedStyled[domElement] = styled(domElement);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="constructwithoptions"><a class="markdownIt-Anchor" href="#constructwithoptions"></a> constructWithOptions</h2>
<p>从上面的代码可以看出，我们通过一个方法生成了 <code>styled</code>，下面看看这个方法：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">constructWithOptions</span>&lt;</span></span><br><span class="line"><span class="function">    <span class="title">Constructor</span> <span class="title">extends</span> <span class="title">Function</span> = <span class="title">IStyledComponentFactory</span>,</span></span><br><span class="line"><span class="function">    <span class="title">OuterProps</span> = <span class="title">undefined</span></span></span><br><span class="line"><span class="function">&gt;(<span class="params">componentConstructor: Constructor, tag: WebTarget, options: Options = EMPTY_OBJECT <span class="keyword">as</span> <span class="built_in">Object</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> templateFunction = &lt;Props = OuterProps&gt;(</span><br><span class="line">        initialStyles: TemplateStringsArray | SrtledObject | StyledFunction&lt;Props&gt;,</span><br><span class="line">        ...interpolations: Interpolation&lt;Props&gt;[]</span><br><span class="line">    ) =&gt; componentConstructor(tag, options, css(initialStyles, ...interpolations))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Modifiy/inject new props at runtime</span></span><br><span class="line">    templateFunction.attrs = &lt;Props = OuterProps&gt;<span class="function">(<span class="params">attrs: Attrs&lt;Props&gt;</span>) =&gt;</span></span><br><span class="line">        constructWithOptions&lt;Constructor, Props&gt;(componentConstructor, tag, &#123;</span><br><span class="line">            ...options,</span><br><span class="line">            attrs: <span class="built_in">Array</span>.prototype.concat(options.attrs, attrs).filter(<span class="built_in">Boolean</span>)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If config methods are called, wrap up a new template function and merge options</span></span><br><span class="line">    templateFunction.withConfig = <span class="function">(<span class="params">config: Options</span>) =&gt;</span></span><br><span class="line">        constructWithOptions&lt;Constructor, OuterProps&gt;(componentConstructor, tag, &#123;</span><br><span class="line">            ...options,</span><br><span class="line">            ...config</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> templateFunction</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意到 <code>templateFunction.attrs</code> 和 <code>templateFunction.withConfig</code> 中， <code>attrs</code> 和 <code>withConfig</code> 会被合并到 <code>options</code> 中。另外再递归调用 <code>constructWithOptions</code>，这就允许我们在定义 styled component 时可以写链式调用的代码了。</p>
<p>而 <code>constructWithOptions</code> 最核心的代码就是这句：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">componentConstructor(tag, options, css(initialStyles, ...interpolations))</span><br></pre></td></tr></table></figure>
<p>我们注意到这实际上是两步。第一步，调用 <code>css</code> 生成样式代码。第二部，调用 <code>componentConstructor</code> 生成 <strong>Styled Component</strong>。</p>
<h2 id="css"><a class="markdownIt-Anchor" href="#css"></a> css</h2>
<p>那么，先来看看样式代码的生成。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">css</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    styles: Styles,</span></span></span><br><span class="line"><span class="function"><span class="params">    ...interpolations: <span class="built_in">Array</span>&lt;Interpolation&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">FlattenerResult</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isFunction(styles) || isPlainObject(styles)) &#123;</span><br><span class="line">        <span class="keyword">const</span> styleFunctionOrObject = styles <span class="keyword">as</span> <span class="built_in">Function</span> | ExtensibleObject</span><br><span class="line">        <span class="keyword">return</span> flatten(interleave(EMPTY_ARRAY <span class="keyword">as</span> <span class="built_in">string</span>[], [styleFunctionOrObject, ...interpolations]))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> styleStringArray = styles <span class="keyword">as</span> <span class="built_in">string</span>[]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        interpolations.length === <span class="number">0</span> &amp;&amp;</span><br><span class="line">        styleStringArray.length === <span class="number">1</span> &amp;&amp;</span><br><span class="line">        <span class="keyword">typeof</span> styleStringArray[<span class="number">0</span>] === <span class="string">'string'</span></span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">return</span> styleStringArray</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> flatten(interleave(styleStringArray, interpolations))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>事实上，<code>flatten</code> 函数就可以处理各种情况的样式输入：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">flatten</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    chunk: Interpolation,</span></span></span><br><span class="line"><span class="function"><span class="params">    executionContext?: ExtensibleObject,</span></span></span><br><span class="line"><span class="function"><span class="params">    styleSheet?: StyleSheet,</span></span></span><br><span class="line"><span class="function"><span class="params">    stylisInstance?: Stringifier</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">RuleSet</span> | <span class="title">string</span> | <span class="title">IStyledComponent</span> | <span class="title">keyframes</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(chunk)) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isFalsish(chunk)) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isStyledComponent(chunk)) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isFunction(chunk)) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (chunk <span class="keyword">instanceof</span> Keyframes) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> isPlainObject(chunk) ? objToCssArray(chunk <span class="keyword">as</span> ExtensibleObject) : chunk.toString()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="createstyledcomponent"><a class="markdownIt-Anchor" href="#createstyledcomponent"></a> createStyledComponent</h2>
<p>在获得了样式代码之后，我们可以看一下如何创建一个组件。这里调用了 <code>createStyledComponent</code> 函数来创建，看一下源码：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> createStyledComponent: IStyledComponentFactory = (</span><br><span class="line">    target, options, rules</span><br><span class="line">) =&gt; &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    attrs = EMPTY_ARRAY,</span><br><span class="line">    <span class="comment">// 组件 id</span></span><br><span class="line">    componentId = generateId(options.displayName, options.parentComponentId),</span><br><span class="line">    displayName = generateDisplayName(target)</span><br><span class="line">  &#125; = options</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> styledComponentId =</span><br><span class="line">    options.displayName &amp;&amp; options.componentId</span><br><span class="line">  		? <span class="string">`<span class="subst">$&#123;<span class="built_in">escape</span>(options.displayName)&#125;</span>-<span class="subst">$&#123;options.componentId&#125;</span>`</span></span><br><span class="line">  		: options.componentId || componentId;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> componentStyle = <span class="keyword">new</span> ComponentStyle(</span><br><span class="line">  	rules,</span><br><span class="line">    styledComponentId,</span><br><span class="line">    isTargetStyledComp ? (styledComponentTarget.componentStyle <span class="keyword">as</span> ComponentStyle) : <span class="literal">undefined</span></span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">let</span> WrappedStyledComponent: IStyledComponent</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">forwardRef</span>(<span class="params">props: ExtensibleObject, ref: Ref&lt;Element&gt;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> useStyledComponentImpl(WrappedStyledComponent, props, ref, isStatic);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 传递组件引用，以便于可以使用 ref 来操作元素</span></span><br><span class="line">  WrappedStyledComponent = React.forwardRef(forWardRef) <span class="keyword">as</span> unknown <span class="keyword">as</span> IStyledComponent;</span><br><span class="line">  WrappedStyledComponent.attrs = finalAttrs;</span><br><span class="line">  WrappedStyledComponent.componentStyle = componentStyle;</span><br><span class="line">  WrappedStyledComponent.displayName = displayName;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  WrappedStyledComponent.withComponent = <span class="function"><span class="keyword">function</span> <span class="title">withComponent</span>(<span class="params">tag: WebTarget</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; componentId: previousComponentId, ...optionsToCopy &#125; = options;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> newComponentId =</span><br><span class="line">      previousComponentId &amp;&amp;</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;previousComponentId&#125;</span>-<span class="subst">$&#123;isTag(tag) ? tag : <span class="built_in">escape</span>(getComponentName(tag))&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> newOptions = &#123;</span><br><span class="line">      ...optionsToCopy,</span><br><span class="line">      attrs: finalAttrs,</span><br><span class="line">      componentId: newComponentId,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> createStyledComponent(tag, newOptions, rules);</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> WrappedStyledComponent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意到 <code>componentStyle</code> 的实现，是实例化了 <code>ComponentStyle</code> 类。那么，看一下这个类的实现：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> ComponentStyle &#123;</span><br><span class="line">  baseHash: <span class="built_in">number</span>;</span><br><span class="line">  baseStyle: ComponentStyle | <span class="literal">null</span> | <span class="literal">undefined</span>;</span><br><span class="line">  componentId: <span class="built_in">string</span>;</span><br><span class="line">  isStatic: <span class="built_in">boolean</span>;</span><br><span class="line">  rules: RuleSet;</span><br><span class="line">  staticRulesId: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params">rules: RuleSet, componentId: <span class="built_in">string</span>, baseStyle?: ComponentStyle</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.rules = rules;</span><br><span class="line">    <span class="keyword">this</span>.staticRulesId = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">this</span>.isStatic =</span><br><span class="line">      process.env.NODE_ENV === <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">      (baseStyle === <span class="literal">undefined</span> || baseStyle.isStatic) &amp;&amp;</span><br><span class="line">      isStaticRules(rules);</span><br><span class="line">    <span class="keyword">this</span>.componentId = componentId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SC_VERSION gives us isolation between multiple runtimes on the page at once</span></span><br><span class="line">    <span class="comment">// this is improved further with use of the babel plugin "namespace" feature</span></span><br><span class="line">    <span class="keyword">this</span>.baseHash = phash(SEED, componentId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.baseStyle = baseStyle;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> This registers the componentId, which ensures a consistent order</span></span><br><span class="line">    <span class="comment">// for this component's styles compared to others</span></span><br><span class="line">    StyleSheet.registerId(componentId);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  generateAndInjectStyles(</span><br><span class="line">    executionContext: <span class="built_in">Object</span>,</span><br><span class="line">    styleSheet: StyleSheet,</span><br><span class="line">    stylis: Stringifier</span><br><span class="line">  ): <span class="built_in">string</span> &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      styleSheet.insertRules(componentId, name, cssFormatted)</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际上，我们是通过 <code>React.forwardRef</code> 传递了组件引用，在该函数中，实现了 <code>styled-component</code> 。下面来看一下其具体实现：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useStyledComponentImpl</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">	forwardedComponent: IStyledComponent,</span></span></span><br><span class="line"><span class="function"><span class="params">	props: ExtensibleObject,</span></span></span><br><span class="line"><span class="function"><span class="params">  forwardedRef: Ref&lt;Element&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  isStatic: <span class="built_in">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> generatedClassName = useInjectedStyle(</span><br><span class="line">        componentStyle,</span><br><span class="line">        isStatic,</span><br><span class="line">        context,</span><br><span class="line">        process.env.NODE_ENV !== <span class="string">'production'</span> ? forwardedComponent.warnTooManyClasses : <span class="literal">undefined</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> elementToBeCreated: WebTarget = attrs.$<span class="keyword">as</span> || props.$<span class="keyword">as</span> || attrs.as || props.as || target;</span><br><span class="line">    </span><br><span class="line">    propsForElement[</span><br><span class="line">      isTargetTag &amp;&amp;</span><br><span class="line">      domElements.indexOf(elementToBeCreated <span class="keyword">as</span> unknown <span class="keyword">as</span> Extract&lt;<span class="keyword">typeof</span> domElements, <span class="built_in">string</span>&gt;) === <span class="number">-1</span></span><br><span class="line">        ? <span class="string">'class'</span></span><br><span class="line">        : <span class="string">'className'</span></span><br><span class="line">    ] = (foldedComponentIds <span class="keyword">as</span> <span class="built_in">string</span>[])</span><br><span class="line">    	.concat(</span><br><span class="line">            styledComponentId,</span><br><span class="line">            (generatedClassName !== styledComponentId ? generatedClassName : <span class="literal">null</span>) <span class="keyword">as</span> <span class="built_in">string</span>,</span><br><span class="line">            props.className,</span><br><span class="line">            attrs.className</span><br><span class="line">    	)</span><br><span class="line">    	.filter(<span class="built_in">Boolean</span>)</span><br><span class="line">    	.join(<span class="string">' '</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> createElement(elementToBeCreated, propsForElement);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>其中，生成类名的方法 <code>useInjectedStyle</code> 的实现是这样的：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useInjectedStyle</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    componentStyle: ComponentStyle,</span></span></span><br><span class="line"><span class="function"><span class="params">    isStatic: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    resolvedAttrs: T,</span></span></span><br><span class="line"><span class="function"><span class="params">    warnTooManyClasses?: ReturnType&lt;<span class="keyword">typeof</span> createWarnTooManyClasses&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> styleSheet = useStyleSheet();</span><br><span class="line">    <span class="keyword">const</span> stylis = useStylis();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> className = isStatic</span><br><span class="line">        ? componentStyle.generateAndInjectStyles(EMPTY_OBJECT, styleSheet, stylis)</span><br><span class="line">        : componentStyle.generateAndInjectStyles(resolvedAttrs, styleSheet, stylis);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> className</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用的 <code>createElement</code> 方法是 React 提供的，其 api 为：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">React.createElement(</span><br><span class="line">  <span class="keyword">type</span>,</span><br><span class="line">  [props],</span><br><span class="line">  [...children]</span><br><span class="line">)</span><br></pre></td></tr></table></figure></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">ShroXd</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://www.bebopser.com/2021/05/16/styledcomponent/">http://www.bebopser.com/2021/05/16/styledcomponent/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CSS-in-JS/">CSS in JS</a><a class="post-meta__tags" href="/tags/Styled-Component/">Styled-Component</a></div><nav id="pagination"><div class="next-post pull-right"><a href="/2021/05/11/FrontendTest/"><span>当我们谈论前端测试时，我们谈些什么</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: 'ec5cfb9ea4555ffd29ce',
  clientSecret: 'a0747147682b2ae812bb8aceb071ec64a6ddacf6',
  repo: 'ShroXd.github.io',
  owner: 'ShroXd',
  admin: 'ShroXd',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(https://bebopfzj.oss-cn-hangzhou.aliyuncs.com/uPic/2020-10-18-WIuOpc.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2020 - 2021 By ShroXd</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="icp"><a href="http://www.beian.miit.gov.cn/" target="_blank" rel="noopener"><img class="icp-icon" src="/img/icp.png"><span>鲁ICP备19050480号-1</span></a></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.8.2"></script><script src="/js/fancybox.js?version=1.8.2"></script><script src="/js/sidebar.js?version=1.8.2"></script><script src="/js/copy.js?version=1.8.2"></script><script src="/js/fireworks.js?version=1.8.2"></script><script src="/js/transition.js?version=1.8.2"></script><script src="/js/scroll.js?version=1.8.2"></script><script src="/js/head.js?version=1.8.2"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>